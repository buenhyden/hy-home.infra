x-logging-loki: &logging-loki
  driver: loki
  options:
    loki-url: "http:/loki:3100/loki/api/v1/push"

services:
  postgres-primary:
    image: postgres:16.11
    container_name: postgres-primary
    env_file:
      - .env
    networks:
      - infra_net
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      TZ: ${DEFAULT_TIMEZONE}
      # replication 관련 파라미터는 init SQL 또는 커스텀 conf에서 조금 더 튜닝
    volumes:
      - postgres_primary:/var/lib/postgresql/data
      - postgres_primary_init:/docker-entrypoint-initdb.d
    ports:
      - ${POSTGRES_HOST_PORT}:${POSTGRES_PORT}

  postgres-replica1:
    image: postgres:16.11
    container_name: postgres-replica1
    env_file:
      - .env
    networks:
      - infra_net
    volumes:
      - postgres_replica1:/var/lib/postgresql/data
      - postgres_replica_init:/docker-entrypoint-initdb.d
    depends_on:
      - postgres-primary
    command: >
      bash -c " if [ ! -s /var/lib/postgresql/data/PG_VERSION ]; then
        PGPASSWORD=${REPLICATOR_PASSWORD} pg_basebackup
          -h postgres-primary
          -D /var/lib/postgresql/data
          -U ${REPLICATOR_USER}
          -Fp -Xs -P -R;
      fi; exec docker-entrypoint.sh postgres "

  postgres-replica2:
    image: postgres:16.11
    container_name: postgres-replica2
    env_file:
      - .env
    networks:
      - infra_net
    volumes:
      - postgres_replica2:/var/lib/postgresql/data
      - postgres_replica_init:/docker-entrypoint-initdb.d
    depends_on:
      - postgres-primary
    command: >
      bash -c " if [ ! -s /var/lib/postgresql/data/PG_VERSION ]; then
        PGPASSWORD=${REPLICATOR_PASSWORD} pg_basebackup
          -h postgres-primary
          -D /var/lib/postgresql/data
          -U ${REPLICATOR_USER}
          -Fp -Xs -P -R;
      fi; exec docker-entrypoint.sh postgres "

  postgres-exporter:
    image: quay.io/prometheuscommunity/postgres-exporter:v0.16.0
    container_name: postgres-exporter
    env_file:
      - .env
    networks:
      - infra_net
    environment:
      # primary를 scrape 대상으로 사용 (필요 시 replica도 multi-target로 확장)
      DATA_SOURCE_NAME: >
        postgresql://${POSTGRES_EXPORTER_USER}:${POSTGRES_EXPORTER_PASSWORD}
        @postgres-primary:5432/${POSTGRES_DB}?sslmode=disable
    ports:
      - "${POSTGRES_EXPORTER_HOST_PORT}:${POSTGRES_EXPORTER_PORT}"

volumes:
  postgres_primary:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_POSTGRESQL_DATA_DIR}/primary
  postgres_primary_init:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_CONFIG_DIR}/postgres/init/primary
  postgres_replica1:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_POSTGRESQL_DATA_DIR}/replica1
  postgres_replica2:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_POSTGRESQL_DATA_DIR}/replica2
  postgres_replica_init:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${DEFAULT_CONFIG_DIR}/postgres/init/replica
