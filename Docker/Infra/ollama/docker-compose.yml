services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "${OLLAMA_HOST_PORT}:${OLLAMA_PORT}"    
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - infra_net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "${QDRANT_HOST_PORT}:${QDRANT_PORT}"
    environment:
      - QDRANT__TELEMETRY_DISABLED=false # 메트릭 수집 활성화
    volumes:
      - qdrant-data:/qdrant/storage
    restart: unless-stopped
    networks:
      - infra_net

  # 2. Open WebUI 서비스 (선택 사항: ChatGPT 같은 웹 인터페이스)
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "${OLLAMA_WEBUI_HOST_PORT}:${OLLAMA_WEBUI_PORT}" # 브라우저에서 localhost:3000 으로 접속
    environment:
      - OLLAMA_BASE_URL=http://ollama:${OLLAMA_PORT} # 도커 네트워크 내부 통신
      # --- RAG 설정 추가 ---
      # 벡터 DB 연결 설정
      - VECTOR_DB_URL=http://qdrant:${QDRANT_PORT}
      # 임베딩(텍스트를 숫자로 변환) 작업을 Ollama에게 맡김
      - RAG_EMBEDDING_ENGINE=ollama
      - RAG_EMBEDDING_MODEL=nomic-embed-text
    volumes:
      - ollama-webui:/app/backend/data
    depends_on:
      - ollama
      - qdrant
    restart: unless-stopped
    networks:
      - infra_net


