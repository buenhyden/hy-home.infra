server:
  # Tempo 자체 HTTP 포트 (query, metrics 등)
  http_listen_port: 3200

distributor:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318

ingester:
  # dev 용: block 자주 자르기
  max_block_duration: 5m
  trace_idle_period: 10s

compactor:
  compaction:
    compaction_window: 1h
    max_block_bytes: 100_000_000
    block_retention: 24h # 하루치 데이터 보관
    compacted_block_retention: 1h

# ---------- 메트릭 생성기 설정 (Tempo → Prometheus remote_write) ----------
metrics_generator:
  ring:
    kvstore:
      store: inmemory # 단일 노드 구성이므로 인메모리 사용 (Empty ring 오류 해결)
  processor:
    span_metrics:
      dimensions:
        - service.name
        - http.method
        - http.status_code
    service_graphs:
      max_items: 10000
  storage:
    # metrics_generator용 WAL 경로
    path: /var/tempo/generator/wal
    remote_write:
      - url: http://prometheus:9090/api/v1/write
        send_exemplars: true

# ---------- Trace 저장소: MinIO(S3) backend ----------
storage:
  trace:
    backend: s3
    # WAL 은 여전히 로컬 디스크 사용 (쓰기 버퍼)
    wal:
      path: /var/tempo/wal

    # S3 backend 설정 (MinIO)
    s3:
      bucket: tempo-bucket # MinIO에 미리 만들어둔 bucket 이름
      endpoint: minio:9000 # Docker 네트워크 상의 MinIO 엔드포인트
      access_key: ${MINIO_ROOT_USER} # MINIO_ROOT_USER (또는 전용 계정)
      secret_key: ${MINIO_ROOT_PASSWORD} # MINIO_ROOT_PASSWORD (또는 전용 계정 비밀번호)
      insecure: true # http 사용이므로 true

# ---------- 공통 오버라이드 ----------
overrides:
  metrics_generator_processors: [service-graphs, span-metrics, local-blocks]
