services:
  couchdb-1:
    image: couchdb:3.4.2
    container_name: couchdb-1
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USERNAME}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - ERL_FLAGS=-setcookie "${COUCHDB_COOKIE}" -name "couchdb@couchdb-1.infra_net"
      - NODENAME=couchdb@couchdb-1.infra_net
    volumes:
      - couchdb1-data:/opt/couchdb/data
    expose:
      - ${COUCHDB_PORT}
      - ${COUCHDB_ERLANG_MAPPER_PORT}
      - ${COUCHDB_ERLANG_DISTRIBUTION_PORT}
    # ports:
    #   - "${COUCHDB_HOST_PORT}:${COUCHDB_PORT}"
    networks:
      infra_net:
        aliases:
          - couchdb-1.infra_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${COUCHDB_PORT}/_up"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      
      # [Router] 도메인 설정: couchdb.hy-home.local
      - "traefik.http.routers.couchdb.rule=Host(`couchdb.${DEFAULT_URL}`)"
      - "traefik.http.routers.couchdb.entrypoints=websecure"
      - "traefik.http.routers.couchdb.tls=true"
      
      # [Service] 3개의 노드를 하나의 서비스('couchdb-cluster')로 묶음
      - "traefik.http.routers.couchdb.service=couchdb-cluster"
      - "traefik.http.services.couchdb-cluster.loadbalancer.server.port=${COUCHDB_PORT}"
      
      # [Sticky Session] 중요: 한 번 접속한 사용자는 계속 같은 노드로 연결 (일관성 보장)
      - "traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie.name=couchdb_sticky"
  couchdb-2:
    image: couchdb:3.4.2
    container_name: couchdb-2
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USERNAME}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - ERL_FLAGS=-setcookie "${COUCHDB_COOKIE}" -name "couchdb@couchdb-2.infra_net"
      - NODENAME=couchdb@couchdb-2.infra_net
    volumes:
      - couchdb2-data:/opt/couchdb/data
    expose:
      - ${COUCHDB_PORT}
      - ${COUCHDB_ERLANG_MAPPER_PORT}
      - ${COUCHDB_ERLANG_DISTRIBUTION_PORT}
    # ports:
    #   - "${COUCHDB_HOST_PORT}:${COUCHDB_PORT}"
    networks:
      infra_net:
        aliases:
          - couchdb-2.infra_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${COUCHDB_PORT}/_up"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      # Node 1과 완전히 동일한 설정 (같은 서비스 그룹으로 합류)
      - "traefik.http.routers.couchdb.rule=Host(`couchdb.${DEFAULT_URL}`)"
      - "traefik.http.routers.couchdb.service=couchdb-cluster"
      - "traefik.http.services.couchdb-cluster.loadbalancer.server.port=${COUCHDB_PORT}"
      - "traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie.name=couchdb_sticky"
  couchdb-3:
    image: couchdb:3.4.2
    container_name: couchdb-3
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USERNAME}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - ERL_FLAGS=-setcookie "${COUCHDB_COOKIE}" -name "couchdb@couchdb-3.infra_net"
      - NODENAME=couchdb@couchdb-3.infra_net
    volumes:
      - couchdb3-data:/opt/couchdb/data
    expose:
      - ${COUCHDB_PORT}
      - ${COUCHDB_ERLANG_MAPPER_PORT}
      - ${COUCHDB_ERLANG_DISTRIBUTION_PORT}
    # ports:
    #   - "${COUCHDB_HOST_PORT}:${COUCHDB_PORT}"
    networks:
      infra_net:
        aliases:
          - couchdb-3.infra_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${COUCHDB_PORT}/_up"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      # Node 1과 완전히 동일한 설정
      - "traefik.http.routers.couchdb.rule=Host(`couchdb.${DEFAULT_URL}`)"
      - "traefik.http.routers.couchdb.service=couchdb-cluster"
      - "traefik.http.services.couchdb-cluster.loadbalancer.server.port=${COUCHDB_PORT}"
      - "traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.couchdb-cluster.loadbalancer.sticky.cookie.name=couchdb_sticky"

  # ============================================================================
  # Cluster Initializer (Setup Assistant)
  # ============================================================================
  couchdb-cluster-init:
    image: curlimages/curl
    container_name: couchdb-cluster-init
    restart: "no"
    depends_on:
      - couchdb-1
      - couchdb-2
      - couchdb-3
    networks:
      - infra_net
    # 클러스터 조인 명령을 실행합니다.
    command: >
      /bin/sh -c "
        echo 'Waiting for nodes to start...';
        sleep 10;
        
        # 1. 노드 2를 클러스터(노드 1)에 조인
        echo 'Joining Node 2...';
        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:${COUCHDB_PORT}/_cluster_setup \
          -d '{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\", \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"${COUCHDB_PASSWORD}\", \"port\": ${COUCHDB_PORT}, \"node_count\": \"3\", \"remote_node\": \"couchdb@couchdb-2.infra_net\", \"remote_current_user\": \"${COUCHDB_USERNAME}\", \"remote_current_password\": \"${COUCHDB_PASSWORD}\"}';

        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:${COUCHDB_PORT}/_cluster_setup \
          -d '{\"action\": \"add_node\", \"host\":\"couchdb-2.infra_net\", \"port\": ${COUCHDB_PORT}, \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"${COUCHDB_PASSWORD}\"}';

        # 2. 노드 3을 클러스터(노드 1)에 조인
        echo 'Joining Node 3...';
        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:5984/_cluster_setup \
          -d '{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\", \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"${COUCHDB_PASSWORD}\", \"port\": 5984, \"node_count\": \"3\", \"remote_node\": \"couchdb@couchdb-3.infra_net\", \"remote_current_user\": \"${COUCHDB_USERNAME}\", \"remote_current_password\": \"${COUCHDB_PASSWORD}\"}';

        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:5984/_cluster_setup \
          -d '{\"action\": \"add_node\", \"host\":\"couchdb-3.infra_net\", \"port\": 5984, \"username\": \"${COUCHDB_USERNAME}\", \"password\":\"${COUCHDB_PASSWORD}\"}';

        # 3. 클러스터 설정 완료 (Finish)
        echo 'Finishing Cluster Setup...';
        curl -X POST -H 'Content-Type: application/json' \
          http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:5984/_cluster_setup \
          -d '{\"action\": \"finish_cluster\"}';
        
        # 4. 시스템 DB 생성 (단일 노드때와 동일하게 필요함)
        curl -X PUT http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:5984/_users;
        curl -X PUT http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:5984/_replicator;
        curl -X PUT http://${COUCHDB_USERNAME}:${COUCHDB_PASSWORD}@couchdb-1:5984/_global_changes;

        echo 'CouchDB Cluster Setup Complete!';
      "

