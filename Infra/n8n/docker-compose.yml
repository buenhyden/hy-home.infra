services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped    
    # ports:
    #   - ${N8N_HOST_PORT}:${N8N_PORT}
    expose:
      - ${N8N_PORT}
    environment:
      - GENERIC_TIMEZONE=${DEFAULT_TIMEZONE:-Asia/Seoul}
      - TZ=${DEFAULT_TIMEZONE:-Asia/Seoul}      
      # 1. 기본 설정
      # [중요] Traefik 도메인 설정 반영
      - N8N_PROTOCOL=https
      - N8N_HOST=n8n.${DEFAULT_URL}      
      - N8N_PORT=${N8N_PORT}      
      - WEBHOOK_URL=https://n8n.${DEFAULT_URL}/
      - N8N_PUSH_BACKEND=websocket
      # 2. 보안 설정 (암호화 키는 한 번 설정하면 바꾸면 안 됨)
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_EDITOR_BASE_URL=https://n8n.${DEFAULT_URL}
      - N8N_PUBLIC_API_BASE_URL=https://n8n.${DEFAULT_URL}
      # 3. PostgreSQL 연결 (기존 HA 클러스터 활용)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=${POSTGRES_HOSTNAME}
      - DB_POSTGRESDB_PORT=${POSTGRES_WRITE_PORT}  # pg-router의 Write 포트
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=${N8N_DB_USER}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - DB_POSTGRESDB_SSL_ENABLED=true
      - DB_POSTGRESDB_SSL_REJECT_UNAUTHORIZED=false
      # 4. 실행 모드 (자체 실행)
      - EXECUTIONS_MODE=regular
      # --- [모니터링 설정 추가] ---
      - N8N_METRICS=true      
      - N8N_METRICS_PREFIX=n8n_  # 메트릭 이름 앞에 붙을 접두사 (관리하기 편함)
      - N8N_METRICS_INCLUDE_WORKFLOW_ID_LABEL=true # 어떤 워크플로우가 부하를 주는지 식별 가능
      - N8N_METRICS_INCLUDE_NODE_TYPE_LABEL=true   # 어떤 노드(HTTP, Cron 등)가 많이 쓰이는지 확인
    labels:
      - "traefik.enable=true"
      
      # n8n UI & Webhook 라우터 (https://n8n.hy-home.local)
      - "traefik.http.routers.n8n.rule=Host(`n8n.${DEFAULT_URL}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.service=n8n"
      # [중요] n8n 내부 포트 (5678) 연결
      - "traefik.http.services.n8n.loadbalancer.server.port=${N8N_PORT}"      
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      infra_net:
        ipv4_address: 172.19.0.14
    depends_on:
      - pg-router # 루트 docker-compose에서 include 시 유효
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
  n8n-redis:
    image: redis:8.2.3-bookworm # Redis 8.2.x
    container_name: n8n-redis
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.15
    restart: unless-stopped    
    environment:
      - QUEUE_BULL_REDIS_HOST=n8n-redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD_FILE=/run/secrets/redis_password
    volumes:
      # 공통 redis.conf
      - n8n-redis-data:/data
    command: >
      sh -c '
      redis-server 
      --requirepass "$(cat /run/secrets/redis_password)" 
      --appendonly yes 
      --port 6379
      '
    # 클러스터 내부 통신 포트는 expose
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_BUS_PORT}"        
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a $REDIS_PASSWORD -h 127.0.0.1 -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        
  n8n-redis-exporter:
    image: oliver006/redis_exporter:v1.80.0-alpine
    container_name: n8n-redis-exporter
    expose:
      - "${REDIS_EXPORTER_PORT}"
    networks:
      infra_net:
        ipv4_address: 172.19.0.16
    restart: unless-stopped
    secrets:
      - redis_password    
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        echo "Reading password from secret..."
        export REDIS_PASSWORD=$(cat /run/secrets/redis_password | tr -d '\n')
        
        echo "Starting Redis Exporter..."
        # -redis.password-file 대신 -redis.password 사용
        exec /redis_exporter \
          -redis.addr=redis://n8n-redis:6379 \
          -redis.password="$REDIS_PASSWORD" \
          -web.listen-address=:${REDIS_EXPORTER_PORT} 
    depends_on: # healthcheck를 사용하므로 condition으로 변경 (더 안정적)
      n8n-redis: { condition: service_healthy }
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
