services:
  ###############################################################
  # Redis Cluster Nodes (6개: 3 master + 3 replica)
  ###############################################################
  redis-node-0:
    image: redis:8.2.3-bookworm # Redis 8.2.x
    container_name: redis-node-0
    secrets:
      - redis_password
    networks:
      infra_net:
        ipv4_address: 172.19.0.30
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-0
    volumes:
      # 공통 redis.conf
      - ./conf/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      # 데이터 영속화
      - redis-data-0:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    # 클러스터 내부 통신 포트는 expose
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_BUS_PORT}"
    # 호스트에서 디버깅/개발용으로 6379는 0번 노드만 오픈
    ports:
      - "${REDIS_HOST_PORT}:${REDIS_PORT}"
    healthcheck:
      # secret 파일에서 비밀번호 읽어서 PING 체크
      test:
        [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-1:
    image: redis:8.2.3-bookworm
    container_name: redis-node-1
    secrets:
      - redis_password
    networks:
      - infra_net
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-1
    volumes:
      - ./conf/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-1:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_BUS_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-2:
    image: redis:8.2.3-bookworm
    container_name: redis-node-2
    secrets:
      - redis_password
    networks:
      - infra_net
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-2
    volumes:
      - ./conf/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-2:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_BUS_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-3:
    image: redis:8.2.3-bookworm
    container_name: redis-node-3
    secrets:
      - redis_password
    networks:
      - infra_net
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-3
    volumes:
      - ./conf/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-3:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_BUS_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-4:
    image: redis:8.2.3-bookworm
    container_name: redis-node-4
    secrets:
      - redis_password
    networks:
      - infra_net
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-4
    volumes:
      - ./conf/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-4:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_BUS_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redis-node-5:
    image: redis:8.2.3-bookworm
    container_name: redis-node-5
    secrets:
      - redis_password
    networks:
      - infra_net
    restart: unless-stopped
    environment:
      NODE_NAME: redis-node-5
    volumes:
      - ./conf/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./scripts/redis-start.sh:/usr/local/bin/redis-start.sh:ro
      - redis-data-5:/data
    command: ["sh", "/usr/local/bin/redis-start.sh"]
    expose:
      - "${REDIS_PORT}"
      - "${REDIS_BUS_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "REDIS_PASSWORD=$(cat /run/secrets/redis_password); redis-cli -a
          $REDIS_PASSWORD -h 127.0.0.1 -p 6379 ping | grep PONG",
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  ###############################################################
  # Redis Cluster 초기화용 one-shot 컨테이너
  #   - 처음 한 번 실행해서 cluster create
  #   - 이미 클러스터 구성돼 있으면 noop로 끝나도록 스크립트 작성
  ###############################################################
  redis-cluster-init:
    image: redis:8.2
    container_name: redis-cluster-init
    secrets:
      - redis_password
    networks:
      - infra_net
    restart: "no"
    depends_on:
      - redis-node-0
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
    volumes:
      - ./scripts/redis-cluster-init.sh:/usr/local/bin/redis-cluster-init.sh:ro
    command: ["sh", "/usr/local/bin/redis-cluster-init.sh"]
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
  ###############################################################
  # Redis Exporter – Prometheus용 메트릭
  ###############################################################

  redis-exporter:
    image: oliver006/redis_exporter:v1.80.0
    container_name: redis-exporter
    ports:
      - "${REDIS_EXPORTER_HOST_PORT}:${REDIS_EXPORTER_PORT}"
    networks:
      - infra_net
    restart: unless-stopped
    secrets:
      - redis_password
    environment:
      - REDIS_ADDR="redis-node-0:6379"
    command: >
      sh -c "
        REDIS_PASSWORD=$(cat /run/secrets/redis_password);
        exec redis_exporter \
          --redis.password=$REDIS_PASSWORD
      "
    depends_on: # healthcheck를 사용하므로 condition으로 변경 (더 안정적)
      redis-node-0: { condition: service_healthy }
      redis-node-1: { condition: service_healthy }
      redis-node-2: { condition: service_healthy }
      redis-node-3: { condition: service_healthy }
      redis-node-4: { condition: service_healthy }
      redis-node-5: { condition: service_healthy }
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  redisinsight:
    image: redis/redisinsight:latest
    container_name: redisinsight
    networks:
      - infra_net
    ports:
      - "${REDIS_INSIGHT_HOST_PORT}:${REDIS_INSIGHT_PORT}" # 호스트에서 GUI 웹페이지에 접근할 포트
    volumes:
      - redisinsight-data:/db
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
