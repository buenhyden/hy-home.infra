services:
  ###############################################################
  # etcd 3노드 (Patroni DCS)
  ###############################################################
  etcd-1:
    image: quay.io/coreos/etcd:v3.5.15
    container_name: etcd-1
    command:
      - /usr/local/bin/etcd
      - --name=etcd-1
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-1:${ETCD_PEER_PORT}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT}
      - --advertise-client-urls=http://etcd-1:${ETCD_CLIENT_PORT}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT},etcd-2=http://etcd-2:${ETCD_PEER_PORT},etcd-3=http://etcd-3:${ETCD_PEER_PORT}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
      
    volumes:
      - etcd1-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT}
    networks:
      infra_net:
        ipv4_address: 172.19.0.50
    restart: unless-stopped

  etcd-2:
    image: quay.io/coreos/etcd:v3.5.15
    container_name: etcd-2
    command:
      - /usr/local/bin/etcd
      - --name=etcd-2
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-2:${ETCD_PEER_PORT}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT}
      - --advertise-client-urls=http://etcd-2:${ETCD_CLIENT_PORT}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT},etcd-2=http://etcd-2:${ETCD_PEER_PORT},etcd-3=http://etcd-3:${ETCD_PEER_PORT}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
      
    volumes:
      - etcd2-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT}
    networks:
      infra_net:
        ipv4_address: 172.19.0.51
    restart: unless-stopped

  etcd-3:
    image: quay.io/coreos/etcd:v3.5.15
    container_name: etcd-3
    command:
      - /usr/local/bin/etcd
      - --name=etcd-3
      - --data-dir=/etcd-data
      - --initial-advertise-peer-urls=http://etcd-3:${ETCD_PEER_PORT}
      - --listen-peer-urls=http://0.0.0.0:${ETCD_PEER_PORT}
      - --listen-client-urls=http://0.0.0.0:${ETCD_CLIENT_PORT}
      - --advertise-client-urls=http://etcd-3:${ETCD_CLIENT_PORT}
      - --initial-cluster=etcd-1=http://etcd-1:${ETCD_PEER_PORT},etcd-2=http://etcd-2:${ETCD_PEER_PORT},etcd-3=http://etcd-3:${ETCD_PEER_PORT}
      - --initial-cluster-state=new
      - --initial-cluster-token=pg-ha-etcd
      
    volumes:
      - etcd3-data:/etcd-data
    expose:
      - ${ETCD_CLIENT_PORT}
    networks:
      infra_net:
        ipv4_address: 172.19.0.52
    restart: unless-stopped

  ###############################################################
  # Patroni + PostgreSQL 17 노드 3개
  ###############################################################
  pg-0:
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-0
    hostname: pg-0
    env_file:
      - .env.postgres
    environment:      
      SCOPE: "pg-ha"
      # etcd 클러스터 주소
      ETCD3_HOSTS: "etcd-1:2379,etcd-2:2379,etcd-3:2379"      
      # --------------------------------------------------------------------
      # 2. Patroni 네이티브 오버라이드 (세부 설정 제어)
      # --------------------------------------------------------------------
      PATRONI_NAME: pg-0
      PATRONI_NAMESPACE: /service/
      # 네트워크 바인딩 (이 설정은 유지)
      # REST API
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-0:${PATRONI_RESTAPI_PORT}
      # PostgreSQL listen / connect
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-0:${POSTGRES_PORT}
    volumes:
      - pg0-data:/home/postgres/pgdata      
    expose:
      - ${POSTGRES_PORT}
    networks:
      infra_net:
        ipv4_address: 172.19.0.53
    depends_on:
      - etcd-1
      - etcd-2
      - etcd-3
    restart: unless-stopped

  pg-1:
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-1
    hostname: pg-1
    env_file:
      - .env.postgres
    environment:      
      SCOPE: "pg-ha"
      # etcd 클러스터 주소
      ETCD3_HOSTS: "etcd-1:2379,etcd-2:2379,etcd-3:2379"      
      # --------------------------------------------------------------------
      # 2. Patroni 네이티브 오버라이드 (세부 설정 제어)
      # --------------------------------------------------------------------
      PATRONI_NAME: pg-1
      PATRONI_NAMESPACE: /service/
      # 네트워크 바인딩 (이 설정은 유지)
      # REST API
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-1:${PATRONI_RESTAPI_PORT}
      # PostgreSQL listen / connect
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-1:${POSTGRES_PORT}      
    volumes:
      - pg1-data:/home/postgres/pgdata      
    networks:
      infra_net:
        ipv4_address: 172.19.0.54
    expose:
      - ${POSTGRES_PORT}
    depends_on:
      - etcd-1
      - etcd-2
      - etcd-3
    restart: unless-stopped

  pg-2:
    image: ghcr.io/zalando/spilo-17:4.0-p3
    container_name: pg-2
    hostname: pg-2
    env_file:
      - .env.postgres
    environment:      
      SCOPE: "pg-ha"
      # etcd 클러스터 주소
      ETCD3_HOSTS: "etcd-1:2379,etcd-2:2379,etcd-3:2379"
      # 계정 비밀번호 (Spilo가 initdb 시 사용)      
      # --------------------------------------------------------------------
      # 2. Patroni 네이티브 오버라이드 (세부 설정 제어)
      # --------------------------------------------------------------------
      PATRONI_NAME: pg-2
      PATRONI_NAMESPACE: /service/
      # 네트워크 바인딩 (이 설정은 유지)
      # REST API
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:${PATRONI_RESTAPI_PORT}
      PATRONI_RESTAPI_CONNECT_ADDRESS: pg-2:${PATRONI_RESTAPI_PORT}
      # PostgreSQL listen / connect
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:${POSTGRES_PORT}
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: pg-2:${POSTGRES_PORT}     
      
    volumes:
      - pg2-data:/home/postgres/pgdata      
    networks:
      infra_net:
        ipv4_address: 172.19.0.55
    expose:
      - ${POSTGRES_PORT}
    depends_on:
      - etcd-1
      - etcd-2
      - etcd-3
    restart: unless-stopped

  ###############################################################
  # HAProxy 라우터 (Writer/Reader 분리)
  ###############################################################
  pg-router:
    image: haproxy:3.2
    container_name: pg-router    
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "${POSTGRES_WRITE_HOST_PORT}:${POSTGRES_WRITE_PORT}" # Write endpoint
      - "${POSTGRES_READ_HOST_PORT}:${POSTGRES_READ_PORT}" # Read endpoint
      # - "${HAPROXY_HOST_PORT}:${HAPROXY_PORT}" # Stats (옵션)
      - "${HAPROXY_METRICS_HOST_PORT}:${HAPROXY_METRICS_PORT}" # Stats (옵션)
    networks:
      infra_net:
        ipv4_address: 172.19.0.56
    labels:
      - "traefik.enable=true"
      
      # HAProxy Stats UI 라우터
      # 도메인: haproxy.pg.hy-home.local
      - "traefik.http.routers.haproxy-stats.rule=Host(`pg-haproxy.${DEFAULT_URL}`)"
      - "traefik.http.routers.haproxy-stats.entrypoints=websecure"
      - "traefik.http.routers.haproxy-stats.tls=true"
      # [중요] HAProxy 설정 파일(haproxy.cfg)에 정의된 Stats 포트(보통 8404)와 일치해야 함
      - "traefik.http.services.haproxy-stats.loadbalancer.server.port=${HAPROXY_PORT}"
    depends_on:
      - pg-0
      - pg-1
      - pg-2
    restart: unless-stopped

  ###############################################################
  # postgres-exporter (Prometheus / Alloy용 메트릭)
  ###############################################################
  pg-0-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: pg-0-exporter
    networks:
      infra_net:
        ipv4_address: 172.19.0.57
    expose:
      - "${POSTGRES_EXPORTER_PORT}"
    secrets:
      - postgres_password
    depends_on:
      - pg-0    
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/postgres_password | tr -d '\n')
        # pg-0에 직접 접속
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-0:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
  pg-1-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: pg-1-exporter
    networks:
      infra_net:
        ipv4_address: 172.19.0.58
    expose:
      - "${POSTGRES_EXPORTER_PORT}"
    secrets:
      - postgres_password
    depends_on:
      - pg-1  
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/postgres_password | tr -d '\n')
        # pg-0에 직접 접속
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-1:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
  pg-2-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: pg-2-exporter
    networks:
      infra_net:
        ipv4_address: 172.19.0.59
    expose:
      - "${POSTGRES_EXPORTER_PORT}"
    secrets:
      - postgres_password
    depends_on:
      - pg-2  
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        export PGPASSWORD=$$(cat /run/secrets/postgres_password | tr -d '\n')
        # pg-0에 직접 접속
        export DATA_SOURCE_NAME="postgresql://postgres:$$PGPASSWORD@pg-2:5432/postgres?sslmode=require"
        exec /bin/postgres_exporter
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${POSTGRES_EXPORTER_PORT:-9187}/metrics > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
