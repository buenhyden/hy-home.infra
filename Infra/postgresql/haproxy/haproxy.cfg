# haproxy/haproxy.cfg

global
  log stdout  format raw  local0
  maxconn 4096

defaults
  log     global
  mode    tcp
  option  tcplog
  timeout connect 10s
  timeout client  1m
  timeout server  1m

# Prometheus 메트릭 노출 설정
frontend prometheus
  bind *:8404
  mode http
  # /metrics 경로로 요청이 오면 내장된 프로메테우스 익스포터 사용
  http-request use-service prometheus-exporter if { path /metrics }
  no log

# Writer (Primary 전용) - 포트 15432
frontend pg-write
  bind *:15432  
  default_backend pg-primary

backend pg-primary
  mode tcp
  balance roundrobin
  # Patroni REST API로 /master 헬스체크
  option httpchk GET /master
  http-check expect status 200
  # 서버 공통 헬스체크 옵션
  default-server inter 5s fall 3 rise 2 on-marked-down shutdown-sessions
  # 데이터 트래픽은 5432, 헬스체크는 Patroni REST 포트(8008 가정)
  server pg0 pg-0:5432 check port 8008
  server pg1 pg-1:5432 check port 8008
  server pg2 pg-2:5432 check port 8008

# Reader (Replica 전용) - 포트 15433
frontend pg-read
  bind *:15433
  default_backend pg-replicas

backend pg-replicas
  mode tcp
  # Patroni REST API로 /replica 헬스체크
  option httpchk GET /replica
  http-check expect status 200
  balance roundrobin
  default-server inter 5s fall 3 rise 2 on-marked-down shutdown-sessions
  server pg0 pg-0:5432 check port 8008
  server pg1 pg-1:5432 check port 8008
  server pg2 pg-2:5432 check port 8008

# 간단한 상태 페이지 (선택)
listen stats
  bind *:7000
  mode http
  stats enable
  stats uri /
  stats refresh 10s


