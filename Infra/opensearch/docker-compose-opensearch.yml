services:
  #######################################################
  # OpenSearch 노드 1 (cluster_manager + data + ingest)
  #######################################################
  opensearch-node1:
    image: opensearchproject/opensearch:3.3.2 # 2025-11 기준 최신 3.x 안정 버전
    container_name: opensearch-node1
    restart: unless-stopped
    # 비밀번호, 클러스터 이름, JVM 옵션 등은 env 파일에서 주입
    environment:
      # 노드/클러스터 기본 설정
      - node.name=opensearch-node1
      - cluster.name=${OPENSEARCH_CLUSTER_NAME}
      # 클러스터 디스커버리 설정 (3노드 모두 동일하게 설정)
      - discovery.seed_hosts=opensearch-node1,opensearch-node2,opensearch-node3
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2,opensearch-node3
      # JVM Heap 설정 (env에서 값 가져옴)
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      # 메모리 관련 bootstrap 체크 통과용
      - bootstrap.memory_lock=true
      # 노드 역할: 클러스터 매니저 + 데이터 + 인제스트 + 원격 클러스터 클라이언트
      - node.roles=cluster_manager,data,ingest,remote_cluster_client
      # 2.12+ 기준 보안 데모 구성에서 admin 패스워드 설정 (env 파일에서 가져옴)
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${ELASTIC_PASSWORD}
      - "plugins.metrics.enabled=true"
      - "plugins.metrics.prometheus.enabled=true"
      - "plugins.metrics.prometheus.exporter.port=9600"
      - "plugins.metrics.prometheus.exporter.use_insecure=true"
    ulimits:
      # 스왑 방지를 위해 memlock 무제한
      memlock:
        soft: -1
        hard: -1
      # OpenSearch 권장 파일 디스크립터 수
      nofile:
        soft: 65536
        hard: 65536
    # Performance Analyzer가 /dev/shm 를 많이 쓰므로 크기를 넉넉히
    shm_size: 1g
    volumes:
      # 데이터 영속화 볼륨
      - opensearch-data1:/usr/share/opensearch/data
    ports:
      # REST API (TLS on 기본) – Loki/Alloy에서 로그/메트릭 수집, 앱 연결
      - "${ES_HOST_1_PORT}:${ES_PORT}"
      # Performance Analyzer / 메트릭 포트
      - "${ES_PERFORMANCE_ANALYZER_HOST_PORT}:${ES_PERFORMANCE_ANALYZER_PORT}"
    networks:
      infra_net:
        ipv4_address: 172.19.0.40
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  #######################################################
  # OpenSearch 노드 2
  #######################################################
  opensearch-node2:
    image: opensearchproject/opensearch:3.3.2
    container_name: opensearch-node2
    restart: unless-stopped
    environment:
      - node.name=opensearch-node2
      - cluster.name=${OPENSEARCH_CLUSTER_NAME}
      - discovery.seed_hosts=opensearch-node1,opensearch-node2,opensearch-node3
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2,opensearch-node3
      - bootstrap.memory_lock=true
      - node.roles=cluster_manager,data,ingest,remote_cluster_client
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${ELASTIC_PASSWORD}
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - "plugins.metrics.enabled=true"
      - "plugins.metrics.prometheus.enabled=true"
      - "plugins.metrics.prometheus.exporter.port=9600"
      - "plugins.metrics.prometheus.exporter.use_insecure=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    shm_size: 1g
    volumes:
      - opensearch-data2:/usr/share/opensearch/data
    expose:
      - "${ES_PORT}"
      - "${ES_PERFORMANCE_ANALYZER_PORT}"
    networks:
      - infra_net
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  #######################################################
  # OpenSearch 노드 3
  #######################################################
  opensearch-node3:
    image: opensearchproject/opensearch:3.3.2
    container_name: opensearch-node3
    restart: unless-stopped
    environment:
      - node.name=opensearch-node3
      - cluster.name=${OPENSEARCH_CLUSTER_NAME}
      - discovery.seed_hosts=opensearch-node1,opensearch-node2,opensearch-node3
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2,opensearch-node3
      - bootstrap.memory_lock=true
      - node.roles=cluster_manager,data,ingest,remote_cluster_client
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${ELASTIC_PASSWORD}
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - "plugins.metrics.enabled=true"
      - "plugins.metrics.prometheus.enabled=true"
      - "plugins.metrics.prometheus.exporter.port=9600"
      - "plugins.metrics.prometheus.exporter.use_insecure=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    shm_size: 1g
    volumes:
      - opensearch-data3:/usr/share/opensearch/data
    expose:
      - "${ES_PORT}"
      - "${ES_PERFORMANCE_ANALYZER_PORT}"
    networks:
      - infra_net
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:3.3.0
    container_name: opensearch-dashboards
    restart: unless-stopped
    networks:
      - infra_net
    expose:
      - "${KIBANA_PORT}" # Expose port 5601 for web access to OpenSearch Dashboards
    ports:
      - "${KIBANA_HOST_PORT}:${KIBANA_PORT}"
    environment:
      - 'OPENSEARCH_HOSTS=["https://opensearch-node1:9200","https://opensearch-node2:9200","https://opensearch-node3:9200"]'
      - OPENSEARCH_USERNAME=${ELASTIC_USERNAME}
      - OPENSEARCH_PASSWORD=${ELASTIC_PASSWORD}
    depends_on:
      opensearch-node1: { condition: service_started }
      opensearch-node2: { condition: service_started }
      opensearch-node3: { condition: service_started }
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
