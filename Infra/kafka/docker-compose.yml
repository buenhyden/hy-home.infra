services:
  ###############################################################
  # Kafka Broker 1 (KRaft Controller + Broker)
  ###############################################################
  kafka-1:
    image: confluentinc/cp-kafka:7.7.0
    container_name: kafka-1
    hostname: kafka-1
    restart: unless-stopped
    ports:
      - "${KAFKA_CONTROLLER_1_HOST_PORT}:${KAFKA_CONTROLLER_PORT}"
    environment:
      # --- KRaft 공통 ---      
      # 클러스터 ID (3개 브로커 모두 동일해야 함)
      CLUSTER_ID: ${KAFKA_CLSUTER_ID}
      # 이 노드의 고유 ID (브로커/컨트롤러 구분)
      KAFKA_NODE_ID: 1
      # 이 프로세스가 맡을 역할 (KRaft)
      KAFKA_PROCESS_ROLES: "broker,controller"
      # 컨트롤러 쿼럼 구성 (node_id@호스트:컨트롤러포트)
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093"
      # 리스너 설정: 내부용(PLAINTEXT), 컨트롤러용(CONTROLLER), 외부용(EXTERNAL)
      KAFKA_LISTENERS: "PLAINTEXT://kafka-1:19092,CONTROLLER://kafka-1:9093,EXTERNAL://0.0.0.0:${KAFKA_CONTROLLER_PORT}"
      # 광고 주소: 내부는 컨테이너명, 외부는 localhost
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-1:19092,EXTERNAL://localhost:${KAFKA_CONTROLLER_1_HOST_PORT}"
      # 프로토콜 매핑
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT"
      # 컨트롤러 리스너 이름
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      # 브로커 간 통신에 쓸 리스너
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"

      # --- 토픽/복제 관련 ---
      # 내부 토픽 복제/ISR 설정 (3노드 클러스터 기준)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_MIN_INSYNC_REPLICAS: 2
      # 자동 토픽 생성 (개발용 편의)
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      # 로그 디렉터리
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      # 다양한 운영 기본값들
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      # JVM 옵션 (필요하면 조절)
      KAFKA_HEAP_OPTS: "-Xms512m -Xmx512m"
    volumes:
      - kafka-1-data:/var/lib/kafka/data
    networks:
      infra_net:
        ipv4_address: 172.19.0.20    
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server kafka-1:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  ###############################################################
  # Kafka Broker 2
  ###############################################################
  kafka-2:
    image: confluentinc/cp-kafka:7.7.0
    container_name: kafka-2
    hostname: kafka-2
    ports:
      - "${KAFKA_CONTROLLER_2_HOST_PORT}:${KAFKA_CONTROLLER_PORT}"
    environment:
      CLUSTER_ID: ${KAFKA_CLSUTER_ID}
      KAFKA_NODE_ID: 2
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093"

      KAFKA_LISTENERS: "PLAINTEXT://kafka-2:19092,CONTROLLER://kafka-2:9093,EXTERNAL://0.0.0.0:${KAFKA_CONTROLLER_PORT}"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-2:19092,EXTERNAL://localhost:${KAFKA_CONTROLLER_2_HOST_PORT}"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT"

      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0

      KAFKA_HEAP_OPTS: "-Xms512m -Xmx512m"
    volumes:
      - kafka-2-data:/var/lib/kafka/data
    networks:
      infra_net:
        ipv4_address: 172.19.0.21
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server kafka-2:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5  
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  ###############################################################
  # Kafka Broker 3
  ###############################################################
  kafka-3:
    image: confluentinc/cp-kafka:7.7.0
    container_name: kafka-3
    hostname: kafka-3
    ports:
      - "${KAFKA_CONTROLLER_3_HOST_PORT}:${KAFKA_CONTROLLER_PORT}"
    environment:
      CLUSTER_ID: ${KAFKA_CLSUTER_ID}
      KAFKA_NODE_ID: 3
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093"

      KAFKA_LISTENERS: "PLAINTEXT://kafka-3:19092,CONTROLLER://kafka-3:9093,EXTERNAL://0.0.0.0:${KAFKA_CONTROLLER_PORT}"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-3:19092,EXTERNAL://localhost:${KAFKA_CONTROLLER_3_HOST_PORT}"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT"

      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0

      KAFKA_HEAP_OPTS: "-Xms512m -Xmx512m"
    volumes:
      - kafka-3-data:/var/lib/kafka/data
    networks:
      infra_net:
        ipv4_address: 172.19.0.22
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server kafka-3:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # -------------------------------------------
  # 2. Schema Registry (스키마 레지스트리)
  # -------------------------------------------
  schema-registry:
    image: confluentinc/cp-schema-registry:7.7.0
    container_name: schema-registry
    restart: unless-stopped
    networks:
      infra_net:
        ipv4_address: 172.19.0.23
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: "http://0.0.0.0:${SCHEMA_REGISTRY_PORT}"
      # 내부 리스너 포트(19092)로 연결해야 함
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: "PLAINTEXT://kafka-1:19092,PLAINTEXT://kafka-2:19092,PLAINTEXT://kafka-3:19092"
    expose:
      - ${SCHEMA_REGISTRY_PORT}
    # ports:
    #   - "${SCHEMA_REGISTRY_HOST_PORT}:${SCHEMA_REGISTRY_PORT}"
    labels:
      - "traefik.enable=true"
      # 도메인: schema-registry.hy-home.local
      - "traefik.http.routers.schema-registry.rule=Host(`schema-registry.${DEFAULT_URL}`)"
      - "traefik.http.routers.schema-registry.entrypoints=websecure"
      - "traefik.http.routers.schema-registry.tls=true"
      - "traefik.http.services.schema-registry.loadbalancer.server.port=${SCHEMA_REGISTRY_PORT}"
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3      
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  ###############################################################
  # Kafka Connect (Distributed)
  ###############################################################
  kafka-connect:
    image: confluentinc/cp-kafka-connect:7.7.0
    container_name: kafka-connect
    restart: unless-stopped
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
      - schema-registry      
    networks:
      infra_net:
        ipv4_address: 172.19.0.24
    # ports:
    #   - "${KAFKA_CONNECT_HOST_PORT}:${KAFKA_CONNECT_PORT}"
    environment:
      # 내부 리스너 포트(19092) 사용
      CONNECT_BOOTSTRAP_SERVERS: "kafka-1:19092,kafka-2:19092,kafka-3:19092"
      # Connect 클러스터 ID (그룹)
      CONNECT_GROUP_ID: "kafka-connect-cluster"
      # 내부 토픽들 (replication 3으로)
      CONNECT_CONFIG_STORAGE_TOPIC: _connect-configs
      CONNECT_OFFSET_STORAGE_TOPIC: _connect-offsets
      CONNECT_STATUS_STORAGE_TOPIC: _connect-status

      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3

      # Key/Value 변환기 (JSON, Schema-less 예시)
      CONNECT_KEY_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
      CONNECT_VALUE_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
      CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"

      # 내부 변환기
      CONNECT_INTERNAL_KEY_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
      CONNECT_INTERNAL_VALUE_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"

      # REST 리스너
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_REST_PORT: ${KAFKA_CONNECT_PORT}

      # 플러그인 디렉터리 (커스텀 커넥터 넣고 싶을 때 사용)
      CONNECT_PLUGIN_PATH: "/usr/share/java,/usr/share/confluent-hub-components"
      # 오프셋 flush 주기 등 (필요에 따라 조정)
      CONNECT_OFFSET_FLUSH_INTERVAL_MS: 10000

      CONNECT_LOG4J_ROOT_LOGLEVEL: "INFO"
      CONNECT_LOG4J_LOGGERS: "org.apache.kafka.connect.runtime.rest=WARN,org.reflections=ERROR"
      # Schema Registry와 연동
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: "http://schema-registry:${SCHEMA_REGISTRY_PORT}"
      CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: "http://schema-registry:${SCHEMA_REGISTRY_PORT}"
    volumes:
      # 커스텀 커넥터가 있다면 여기에 마운트 (예: ./connect-plugins:/usr/share/confluent-hub-components)
      # - ./connect-plugins:/usr/share/confluent-hub-components
      - kafka-connect-data:/var/lib/kafka-connect
    labels:
      - "traefik.enable=true"
      # 도메인: connect.hy-home.local
      - "traefik.http.routers.kafka-connect.rule=Host(`kafka-connect.${DEFAULT_URL}`)"
      - "traefik.http.routers.kafka-connect.entrypoints=websecure"
      - "traefik.http.routers.kafka-connect.tls=true"
      - "traefik.http.services.kafka-connect.loadbalancer.server.port=${KAFKA_CONNECT_PORT}"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # -------------------------------------------
  # 4. Kafka REST Proxy (레스트 프록시)
  # -------------------------------------------
  kafka-rest-proxy:
    image: confluentinc/cp-kafka-rest:7.7.0
    container_name: kafka-rest-proxy
    restart: unless-stopped
    networks:
      infra_net:
        ipv4_address: 172.19.0.25
    # ports:
    #   - "${KAFKA_REST_PROXY_HOST_PORT}:${KAFKA_REST_PROXY_PORT}"
    labels:
      - "traefik.enable=true"
      # 도메인: kafka-rest.hy-home.local
      - "traefik.http.routers.kafka-rest.rule=Host(`kafka-rest.${DEFAULT_URL}`)"
      - "traefik.http.routers.kafka-rest.entrypoints=websecure"
      - "traefik.http.routers.kafka-rest.tls=true"
      - "traefik.http.services.kafka-rest.loadbalancer.server.port=${KAFKA_REST_PROXY_PORT}"

    environment:
      KAFKA_REST_HOST_NAME: kafka-rest-proxy
      KAFKA_REST_LISTENERS: "http://0.0.0.0:${KAFKA_REST_PROXY_PORT}"
      # 내부 리스너 사용
      KAFKA_REST_BOOTSTRAP_SERVERS: "PLAINTEXT://kafka-1:19092,PLAINTEXT://kafka-2:19092,PLAINTEXT://kafka-3:19092"
      KAFKA_REST_SCHEMA_REGISTRY_URL: "http://schema-registry:${SCHEMA_REGISTRY_PORT}"
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
      - schema-registry      
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # -------------------------------------------
  # 5. Kafka UI (카프카 UI - Provectus)
  # -------------------------------------------
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    networks:
      infra_net:
        ipv4_address: 172.19.0.26
    environment:
      KAFKA_CLUSTERS_0_NAME: ${KAFKA_CLSUTER_NAME}
      # 내부 리스너 사용
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka-1:19092,kafka-2:19092,kafka-3:19092"
      # UI가 Schema Registry에 접속하는 주소 (컨테이너 내부 통신)
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: "http://schema-registry:${SCHEMA_REGISTRY_PORT}"
      # UI가 Kafka Connect에 접속하는 주소 (컨테이너 내부 통신)
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME: "kafka-connect"
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS: "http://kafka-connect:${KAFKA_CONNECT_PORT}"
    expose:
      - ${KAFKA_UI_PORT}
    # ports:
    #   - "${KAFKA_UI_HOST_PORT}:${KAFKA_UI_PORT}" # Host -> Container
    labels:
      - "traefik.enable=true"
      # 도메인: kafka-ui.hy-home.local
      - "traefik.http.routers.kafka-ui.rule=Host(`kafka-ui.${DEFAULT_URL}`)"
      - "traefik.http.routers.kafka-ui.entrypoints=websecure"
      - "traefik.http.routers.kafka-ui.tls=true"
      - "traefik.http.services.kafka-ui.loadbalancer.server.port=${KAFKA_UI_PORT}"
      - "traefik.http.routers.kafka-ui.middlewares=sso-auth@file"
    depends_on:
      - kafka-1
      - kafka-2
      - kafka-3
      - schema-registry
      - kafka-connect
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  kafka-exporter:
    image: danielqsj/kafka-exporter:v1.7.0
    container_name: kafka-exporter
    restart: unless-stopped
    command:
      # 내부 리스너 사용
      - --kafka.server=kafka-1:19092
      - --kafka.server=kafka-2:19092
      - --kafka.server=kafka-3:19092
    # ports:
    #   - "${KAFKA_EXPORTER_HOST_PORT}:${KAFKA_EXPORTER_PORT}"
    networks:
      infra_net:
        ipv4_address: 172.19.0.27
    depends_on:
      kafka-1:
        condition: service_healthy
      kafka-2:
        condition: service_healthy
      kafka-3:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"